<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>Chi Ti·∫øt S·ª± Ki·ªán</title>
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" />
    <link href="assets/css/styles.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body id="page-top" class="bg-light">
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
        <div class="container">
            <a class="navbar-brand" href="index.html">EVENT SYSTEM</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto py-4 py-lg-0">
                    <li class="nav-item"><a class="nav-link" href="index.html">Trang Ch·ªß</a></li>
                    <li class="nav-item"><a class="nav-link" href="profile.html">V√© C·ªßa T√¥i</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="page-section">
        <div class="container mt-5">
            <div class="row">
                <div class="col-lg-8">
                    <h2 class="text-uppercase mb-3" id="eName">ƒêang t·∫£i...</h2>
                    <p class="text-muted mb-4"><i class="fas fa-map-marker-alt me-2"></i> <span id="eLoc">...</span></p>
                    
                    <img class="img-fluid d-block mx-auto rounded mb-5 shadow-sm w-100" src="assets/assets/img/portfolio/1.jpg" alt="..." style="height: 400px; object-fit: cover;" />
                    
                    <h4>Th√¥ng Tin S·ª± Ki·ªán</h4>
                    <p id="eDesc" class="text-justify">...</p>
                    <hr>
                    <div class="row text-muted">
                        <div class="col-md-6"><p>üìÖ B·∫Øt ƒë·∫ßu: <span id="eStart" class="fw-bold text-dark"></span></p></div>
                        <div class="col-md-6"><p>üèÅ K·∫øt th√∫c: <span id="eEnd" class="fw-bold text-dark"></span></p></div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card border-0 shadow sticky-top" style="top: 100px;">
                        <div class="card-header bg-warning text-white text-center">
                            <h4 class="m-0 text-uppercase fw-bold">CH·ªåN V√â NGAY</h4>
                        </div>
                        <div class="card-body" id="ticket-container">
                            <div class="text-center py-3">
                                <div class="spinner-border text-warning" role="status"></div>
                                <p class="mt-2">ƒêang t·∫£i danh s√°ch v√©...</p>
                            </div>
                        </div>
                        <div class="card-footer bg-white text-center text-muted small">
                            <i class="fas fa-shield-alt"></i> Thanh to√°n an to√†n & b·∫£o m·∫≠t
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="../config.js"></script>
    <script>
        // H√†m Toast
        function showToast(icon, message) {
            Swal.fire({ toast: true, position: 'top-end', icon: icon, title: message, showConfirmButton: false, timer: 1500, timerProgressBar: true });
        }

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        const token = localStorage.getItem('token');

        // Ki·ªÉm tra ID
        if(eventId) {
            loadDetail();
        } else {
            window.location.href = "index.html";
        }

        // --- LOGIC T·∫¢I CHI TI·∫æT ---
        async function loadDetail() {
            try {
                const res = await fetch(`${API_BASE_URL}/events/${eventId}`);
                if(!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán");
                
                const evt = await res.json();

                // 1. ƒêi·ªÅn th√¥ng tin s·ª± ki·ªán
                document.getElementById('eName').innerText = evt.name;
                document.getElementById('eLoc').innerText = evt.location;
                document.getElementById('eDesc').innerText = evt.description || "Ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt.";
                document.getElementById('eStart').innerText = new Date(evt.startDate).toLocaleString('vi-VN');
                document.getElementById('eEnd').innerText = new Date(evt.endDate).toLocaleString('vi-VN');

                // 2. V·∫Ω danh s√°ch v√©
                const tContainer = document.getElementById('ticket-container');
                tContainer.innerHTML = "";
                
                if(evt.tickets && evt.tickets.length > 0) {
                    evt.tickets.forEach(t => {
                        const price = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(t.price);
                        
                        // Ki·ªÉm tra h·∫øt v√©
                        const isSoldOut = t.availableQuantity <= 0;
                        const btnClass = isSoldOut ? 'btn-secondary disabled' : 'btn-outline-warning';
                        const btnText = isSoldOut ? 'H·∫æT V√â' : 'MUA NGAY';
                        const ticketColor = isSoldOut ? 'text-muted' : 'text-dark';

                        tContainer.innerHTML += `
                            <div class="border rounded p-3 mb-3 ${isSoldOut ? 'bg-light' : ''}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="m-0 ${ticketColor} fw-bold">${t.typeName}</h5>
                                    <span class="fw-bold text-success fs-5">${price}</span>
                                </div>
                                <div class="small text-muted mb-3">
                                    <i class="fas fa-ticket-alt me-1"></i> C√≤n l·∫°i: <strong>${t.availableQuantity}</strong> v√©
                                </div>
                                <div class="d-grid">
                                    <button class="btn ${btnClass} fw-bold py-2" onclick="buyTicket(${t.id})">
                                        ${btnText}
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    tContainer.innerHTML = "<p class='text-center text-muted py-3'>Ch∆∞a c√≥ v√© m·ªü b√°n cho s·ª± ki·ªán n√†y.</p>";
                }

            } catch (err) {
                console.error(err);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·ª± ki·ªán.', 'error').then(() => {
                    window.location.href = "index.html";
                });
            }
        }

        // --- LOGIC MUA V√â ---
        async function buyTicket(ticketId) {
            // 1. Check ƒëƒÉng nh·∫≠p
            if(!token) {
                Swal.fire({
                    title: 'C·∫ßn ƒêƒÉng Nh·∫≠p',
                    text: "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c mua v√©.",
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'ƒêƒÉng Nh·∫≠p Ngay',
                    cancelButtonText: 'ƒê·ªÉ sau'
                }).then((result) => {
                    if (result.isConfirmed) window.location.href = "login.html";
                });
                return;
            }

            // 2. X√°c nh·∫≠n mua
            const confirmResult = await Swal.fire({
                title: 'X√°c nh·∫≠n mua v√©?',
                text: "V√© ƒë√£ mua s·∫Ω kh√¥ng th·ªÉ ho√†n ti·ªÅn.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ffc107',
                confirmButtonText: 'Thanh To√°n Ngay',
                cancelButtonText: 'H·ªßy b·ªè'
            });

            if (!confirmResult.isConfirmed) return;

            // 3. G·ªçi API
            try {
                const res = await fetch(`${API_BASE_URL}/events/register`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ ticketId: ticketId })
                });

                const data = await res.json();
                if(res.ok) {
                    showToast('success', 'ƒê·∫∑t v√© th√†nh c√¥ng!');
                    setTimeout(() => window.location.href = "profile.html", 1500);
                } else {
                    Swal.fire('Th·∫•t b·∫°i', data.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh", 'error');
                }
            } catch(err) {
                Swal.fire('L·ªói k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi Server.', 'error');
            }
        }
    </script>
</body>
</html>